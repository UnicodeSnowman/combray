//= depend_on_asset client/templates/home.html
//= depend_on_asset client/templates/about.html
//= depend_on_asset client/templates/contact.html
//= depend_on_asset client/templates/services.html
//= depend_on_asset client/templates/current-stock.html
//= depend_on_asset client/templates/current-stock-item.html

angular.module('Combray', ['ngRoute'])
    .value('utils', {
      titleize: function (phrase) {
        return phrase.split(' ').map(function (word) {
          return word.charAt(0).toUpperCase() + word.slice(1);
        }).join(' ');
      }
    })
    .config(['$routeProvider', function ($routeProvider) {
        $routeProvider
            .when('/', {
              templateUrl: '<%=asset_path("client/templates/home.html")%>'
            })
            .when('/current-stock:category?:subcategory?', {
                templateUrl: '<%=asset_path("client/templates/current-stock.html")%>',
                controller: 'CurrentStockCtrl',
                reloadOnSearch: false,
                resolve: {
                    categories: ['$http', '$route', 'utils', function ($http, $route, utils) {
                        return $http.get('/categories').then(function (res) {
                          return res.data.map(function (category) {
                            category.name = utils.titleize(category.name);
                            category.subcategories = category.subcategories.map(function (subcategory) {
                              return utils.titleize(subcategory.name); 
                            });
                            category.open = $route.current.params.category == category.id ? true : false;
                            return category;
                          });
                        })
                    }],
                    items: ['$http', '$route', 'ItemsService', function ($http, $route, itemsService) {
                        var subcategoryId = $route.current.params.subcategory

                        return subcategoryId ? itemsService.all($route.current.params.subcategory).then(function (res) {
                            return res.data;
                        }) : [];
                    }]
                }
            })
            .when('/current-stock/:itemId', {
              templateUrl: '<%=asset_path("client/templates/current-stock-item.html")%>',
                controller: 'CurrentStockItemCtrl',
                resolve: {
                    item: ['ItemsService', '$route', function (itemsService, $route) {
                        return itemsService.find($route.current.params.itemId);
                    }]
                }
            })
            .when('/about', {
              templateUrl: '<%=asset_path("client/templates/about.html")%>'
            })
            .when('/contact', {
              templateUrl: '<%=asset_path("client/templates/contact.html")%>'
            })
            .when('/services', {
//              resolve: {
//                content: ['$http', function ($http) {
//                    return $http.get('/services').then(function (res) {
//                      return res.data;
//                    })
//                }]
//              },
              templateUrl: '<%=asset_path("client/templates/services.html")%>'
            })
            .when('/search', {
                templateUrl: '<%=asset_path("client/templates/current-stock.html")%>',
                controller: 'CurrentStockCtrl',
                resolve: {
                  items: ['ItemsService', function (itemsService) {
                    return itemsService.all().then(function (res) {
                      return res.data;
                    });
                  }], 
                  categories: function () {
                    return [];
                  }
                }
            });
    }]);

angular.module('Combray')
    .service('ItemsService', ['$http', function ($http) {
      this.all = function (subcategory_id) {
        var reqUrl = '/items';

        if (subcategory_id) {
            reqUrl += '?subcategory_id=' + subcategory_id;
        }
        
        return $http.get(reqUrl);
      };

      this.find = function (item_id) {
        return $http.get('/items/' + item_id).then(function (res) {
            return res.data;
        })
      }
    }])
    .filter('ItemsFilter', function () {
      function isMatch (item, query) {
        var result = false;
        if (item.name && item.name.indexOf(query) !== -1)
          result = true;
        if (item.description && item.description.indexOf(query) !== -1)
          result = true;
        else if (item.category && item.category.indexOf(query) !== -1)
          result = true; 
        else if (item.subcategory && item.subcategory.indexOf(query) !== -1)
          result = true; 
        return result; 
      }
      return function (items, query) {
        var result = [];
        return items.reduce(function (acc, item) {
          if (isMatch(item, query))
            acc.push(item);
          return acc; 
        }, [])
      }
    })
    .controller('AppCtrl', ['$scope', '$location', function ($scope, $location) {
      $scope.$watch(function () { return $location.path(); }, function (path) {
        $scope.isSearch = path === '/search';
      });

      $scope.query = '';
    }])
    .controller('CurrentStockCtrl', [
      '$scope', 
      '$location', 
      '$http',
      '$filter',
      'ItemsService',
      'categories',
      'items', function ($scope, $location, $http, $filter, itemsService, categories, items) {

      var itemsFilter = $filter('ItemsFilter');

      $scope.categories = categories;
      $scope.$watch('query', function (q) {
        $scope.items = $scope.query ? itemsFilter(items, $scope.query) : items;
      });

      $scope.onCategoryClick = function (category, subcategory) {
          $location.search('subcategory', null);
          $location.search('category', category.id);

          if (subcategory) {
              $location.search('subcategory', subcategory.id);
              itemsService.all(subcategory.id).then(function (res) {
                  $scope.items = res.data;
              })
          } else {
              category.open = !category.open;
          }
      }
    }])
    .controller('CurrentStockItemCtrl', [
      '$scope', 
      '$location', 
      'item', function ($scope, $location, item) {

      var $mainImage = angular.element('.main-image img');

      $scope.onThumbClick = function (thumb) {
          $mainImage.attr('src', thumb.photo.main_show.url);
          $scope.current = thumb.photo;
      }

      $scope.current = item.photos[0].photo;
      $scope.item = item;
    }]);
