//= depend_on_asset client/templates/home.html
//= depend_on_asset client/templates/about.html
//= depend_on_asset client/templates/contact.html
//= depend_on_asset client/templates/services.html
//= depend_on_asset client/templates/current-stock.html
//= depend_on_asset client/templates/current-stock-item.html

angular.module('Combray', ['ngRoute'])
    .config(['$routeProvider', function ($routeProvider) {
        $routeProvider
            .when('/', {
              templateUrl: '<%=asset_path("client/templates/home.html")%>'
            })
            .when('/current-stock:category?:subcategory?', {
              templateUrl: '<%=asset_path("client/templates/current-stock.html")%>',
                controller: 'CurrentStockCtrl',
                reloadOnSearch: true,
                resolve: {
                    categories: ['$http', '$route', function ($http, $route) {
                        return $http.get('/categories').then(function (res) {
                          return $(res.data).map(function (i, category) {
                            category.open = $route.current.params.category == category.id ? true : false;
                            return category;
                          });
                        })
                    }],
                    items: ['$http', '$route', 'ItemsService', function ($http, $route, itemsService) {
                        var subcategoryId = $route.current.params.subcategory

                        return subcategoryId ? itemsService.all($route.current.params.subcategory).then(function (res) {
                            return res.data;
                        }) : [];
                    }]
                }
            })
            .when('/current-stock/:itemId', {
              templateUrl: '<%=asset_path("client/templates/current-stock-item.html")%>',
                controller: 'CurrentStockItemCtrl',
                resolve: {
                    item: ['$http', '$route', function ($http, $route) {
                        return $http.get('/items/' + $route.current.params.itemId).then(function (res) {
                            return res.data;
                        })
                    }]
                }
            })
            .when('/about', {
              templateUrl: '<%=asset_path("client/templates/about.html")%>'
            })
            .when('/contact', {
              templateUrl: '<%=asset_path("client/templates/contact.html")%>'
            })
            .when('/services', {
              templateUrl: '<%=asset_path("client/templates/services.html")%>'
            });
    }]);

angular.module('Combray').controller('AppCtrl', ['$scope', function ($scope) { }])
.service('ItemsService', ['$http', function ($http) {
    this.all = function (subcategory_id) {
      var reqUrl = '/items';

      if (subcategory_id) {
          reqUrl += '?subcategory_id=' + subcategory_id;
      }
      
      return $http.get(reqUrl);
    }  
}])
.controller('CurrentStockCtrl', [
    '$scope', 
    '$location', 
    '$http',
    'ItemsService',
    'categories',
    'items', function ($scope, $location, $http, itemsService, categories, items) {

    $scope.categories = categories;
    $scope.items = items;

    $scope.onCategoryClick = function (category, subcategory) {
        $location.search('subcategory', null);
        $location.search('category', category.id);

        if (subcategory) {
            $location.search('subcategory', subcategory.id);
            itemsService.all(subcategory.id).then(function (res) {
                $scope.items = res.data;
            })
        } else {
            category.open = !category.open;
        }
    }
}])
.controller('CurrentStockItemCtrl', [
    '$scope', 
    '$location', 
    'item', function ($scope, $location, item) {

    var $mainImage = angular.element('.main-image img');

    $scope.onThumbClick = function (thumb) {
        $mainImage.attr('src', thumb.photo.main_show.url);
    }
    $scope.item = item;
}]);
